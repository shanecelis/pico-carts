pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- scaling pico sprites
-- by @mykie on twitter
-- https://mishkabear.itch.io/pico-8-rotate
function _init()
 ang=0
 scale=1
 scale_adjust=0.1
 run=true

 -- this indexes a single sprite which
 --  is a 2d array of color ids
 cls()
 spr(1,0,0)
 sprite={}
 for x=1,8 do
  sprite[x]={}
  for y=1,8 do
   sprite[x][y]=pget(x-1,y-1)
  end
 end
 cls()
end

function _update()
  if (btn(1)) ang+=3
  if (btn(0)) ang-=3
  if (btn(2)) scale+=scale_adjust
  if (btn(3)) scale-=scale_adjust
  if (btnp(4)) run= not run
  if run then
    ang+=3
    scale+=scale_adjust
    if scale>=5 then
      scale_adjust=-0.1
    elseif scale<=1 then
      scale_adjust=0.1
    end
  end
end

function _draw()
 cls()
 print((stat(1)*100).."% cpu",0,0,9)
 print((stat(0)).." mem",0,6,9)
 print((stat(7)).." fps",0,12,9)
 sprr(1,96,64,1,1,true,true,scale,ang, 4, 4)
end

function sprr(n,x,y,w,h,flip_x,flip_y,s,a,ax,ay)
 w = w or 1
 h = h or 1
 ax = ax or 0
 ay = ay or 0
 local vs = box(w * 8, h * 8)
 local m1 = {}
 local ws = {}
 local sx = n % 16 * 8
 local sy = flr(n/16) * 16
 local m = mulm(mulm(rotate(-(a or 0)/360),_scale(s or 1)), translate(-ax,-ay))
 mulm(translate(x + ax, y + ay), m, m1)
 mulv(m1, vs, ws)
 local cs ={sx,        sy,
            sx + 8 * w,sy,
            sx + 8 * w,sy + 8*h,
            sx,        sy + 8*h}
 if (flip_x) cs[1],cs[3],cs[5],cs[7] = cs[3],cs[1],cs[7],cs[5]
 if (flip_y) cs[2],cs[4],cs[6],cs[8] = cs[6],cs[8],cs[2],cs[4]
 fill_rect(ws, cs)
end

function _scale(x, y)
  return {x, 0,      0,
          0, y or x, 0,
          0, 0,      1 }
end

function translate(x, y)
  return {1, 0, x,
          0, 1, y,
          0, 0, 1 }
end

function rotate(a)
  local c = cos(a)
  local s = sin(a)
  return {c, -s, 0,
          s,  c, 0,
          0,  0, 1 }
end

function mulv(m, v, r)
  r = r or {}
  for i = 1,#v,3 do
    r[i + 0] = m[1] * v[i] + m[2] * v[i + 1] + m[3] * v[i + 2]
    r[i + 1] = m[4] * v[i] + m[5] * v[i + 1] + m[6] * v[i + 2]
    r[i + 2] = m[7] * v[i] + m[8] * v[i + 1] + m[9] * v[i + 2]
  end
  return r
end

function mulm(m, n, r)
  r = r or {}
  r[1] = m[1]*n[1] + m[2]*n[4] + m[3]*n[7]
  r[2] = m[1]*n[2] + m[2]*n[5] + m[3]*n[8]
  r[3] = m[1]*n[3] + m[2]*n[6] + m[3]*n[9]

  r[4] = m[4]*n[1] + m[5]*n[4] + m[6]*n[7]
  r[5] = m[4]*n[2] + m[5]*n[5] + m[6]*n[8]
  r[6] = m[4]*n[3] + m[5]*n[6] + m[6]*n[9]

  r[7] = m[7]*n[1] + m[8]*n[4] + m[9]*n[7]
  r[8] = m[7]*n[2] + m[8]*n[5] + m[9]*n[8]
  r[9] = m[7]*n[3] + m[8]*n[6] + m[9]*n[9]
  return r
end


function box(w, h)
 return {0, 0,      1,
         w, 0,      1,
         w, h or w, 1,
         0, h or w, 1}
end


fill_rect = function(vs, cs)
  raster({vs[1], vs[2]}, {vs[7], vs[8]}, {vs[4], vs[5]}, {cs[1],cs[2]}, {cs[5],cs[6]}, {cs[3],cs[4]})
  pal(8, 11)
  pal(2, 3)
  raster({vs[1], vs[2]}, {vs[10], vs[11]}, {vs[7], vs[8]}, {cs[1],cs[2]}, {cs[7],cs[8]}, {cs[5],cs[6]})
  pal()
end

-- https://www.scratchapixel.com/lessons/3d-basic-rendering/rasterization-practical-implementation/rasterization-stage.html
function edge(a, b, c)
 return (c[1] - a[1]) * (b[2] - a[2]) - (c[2] - a[2]) * (b[1] - a[1])
end

function raster(v0,v1,v2,c0,c1,c2)
  local lx = flr(min(v0[1], min(v1[1], v2[1])))
  local ux = ceil(max(v0[1], max(v1[1], v2[1])))
  local ly = flr(min(v0[2], min(v1[2], v2[2])))
  local uy = ceil(max(v0[2], max(v1[2], v2[2])))
  local area = edge(v0,v1,v2)
  local c = c0
  local p,w0,w1,w2

  for j=ly,uy do
    for i=lx,ux do
      p = {i + 0.5, j + 0.5};
      w0 = edge(v1, v2, p);
      w1 = edge(v2, v0, p);
      w2 = edge(v0, v1, p);
      if w0 >= 0 and w1 >= 0 and w2 >= 0 then
        if c1 and c2 then
          w0 /= area;
          w1 /= area;
          w2 /= area;
          local ci = w0 * c0[1] + w1 * c1[1] + w2 * c2[1];
          local cj = w0 * c0[2] + w1 * c1[2] + w2 * c2[2];
          c = sget(ci, cj)
        end
        -- peek to take palette swaps into account
        pset(i, j, peek(0x5f00 + c))
      end
    end
  end
end


__gfx__
00000000888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000822882280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700822222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000828228280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000822222280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700882222880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000882882880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
99900000999099909990999090900000099099909090000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90900000009000909090009000900000900090909090000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90900000009000909990999009000000900099909090000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90900000009000909090900090000000900090009090000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99900900009000909990999090900000099090000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99909990000099909990999099900000999099909990000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00909090000090909090900000900000999090009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09909090000090909990999000900000909099009090000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00909090000090900090009000900000909090009090000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99909990090099900090999000900000909099909090000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99909990000099909990099000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00909090000090009090900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09909090000099009990999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00909090000090009000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99909990000090009000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000088880000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000088888880000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000088888888888888000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000088888888888888888000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000888888888888888888888000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000008888888888888888888888888000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000008888888888888888888888888888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000888888888888888888888888888888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000088888888888888888888888888888888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000888888888888888888888888822228888888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000008888888888888888888888888222222228888888880000000000000000000000000000000000000000
00000000000000000000000000000000000000000008888888888888888888888888222222222228888888880000000000000000000000000000000000000000
00000000000000000000000000000000000000000888888888888888888888888822222222222222888888880000000000000000000000000000000000000000
00000000000000000000000000000000000000088888888888888888888888882222222222222222888888888000000000000000000000000000000000000000
00000000000000000000000000000000000888888888888888888888888888882222222222222222888888888000000000000000000000000000000000000000
00000000000000000000000000000000888888888888888888888888888888882222222222222222288888888000000000000000000000000000000000000000
00000000000000000000000000008888888888888888888888888888888888882222222222222222288888888800000000000000000000000000000000000000
00000000000000000000000088888888888888888888888888888888888888888222222222222222288888888800000000000000000000000000000000000000
00000000000000000000000088888888888888888888888888888888888888888222222222222222288888888880000000000000000000000000000000000000
00000000000000000000000088888888888888888888822228888888888888888222222222222222228888888880000000000000000000000000000000000000
00000000000000000000000008888888888888888222222228888888888888888822222222222222228888888888000000000000000000000000000000000000
00000000000000000000000008888888888882222222222228888888888888822222222222222222228888888888000000000000000000000000000000000000
00000000000000000000000008888888882222222222222222888888888882222222222222222222228888888888000000000000000000000000000000000000
00000000000000000000000000888888882222222222222222888888888222222222222222222222222888888888000000000000000000000000000000000000
00000000000000000000000000888888882222222222222222888882222222222222222222222222222888888888800000000000000000000000000000000000
00000000000000000000000000088888882222222222222222222222222222222222222222222222222888888888800000000000000000000000000000000000
00000000000000000000000000088888888222222222222222222222222222222222222228882222222288888888800000000000000000000000000000000000
00000000000000000000000000088888888222222222222222222222222222222222222888882222222288888888800000000000000000000000000000000000
00000000000000000000000000088888888222222222222222222222222222222222288888882222222228888888880000000000000000000000000000000000
00000000000000000000000000008888888222222222222222222222222222222222288888888222222228888888880000000000000000000000000000000000
00000000000000000000000000008888888822222222222222222222222222222222288888888222222222888888880000000000000000000000000000000000
00000000000000000000000000008888888822222222222222222222222222222222288888888222222222888888888000000000000000000000000000000000
00000000000000000000000000000888888822222222222222222222222222222222228888888222222222888888888000000000000000000000000000000000
00000000000000000000000000000888888882222222222222288822222222222222228888888822222222888888888800000000000000000000000000000000
00000000000000000000000000000888888882222222222288888822222222222222228888222222222222288888888800000000000000000000000000000000
00000000000000000000000000000888888888222222228888888822222222222222222222222222222222288888888880000000000000000000000000000000
00000000000000000000000000000088888888222222228888888882222222222222222222222222222222288888888880000000000000000000000000000000
00000000000000000000000000000088888888822222228888888882222222222222222222222222222222288888888880000000000000000000000000000000
00000000000000000000000000000088888888822222222888888882222222222222222222222222222222228888888880000000000000000000000000000000
00000000000000000000000000000088888888822222222888888882222222222222222222222222222288888888888888000000000000000000000000000000
00000000000000000000000000000008888888822222222288888888222222222222222222222222288888888888888888000000000000000000000000000000
00000000000000000000000000000008888888882222222288882222222222222222222222222222288888888888888888000000000000000000000000000000
00000000000000000000000000000008888888882222222222222222222222222222222222222222288888888888888888000000000000000000000000000000
00000000000000000000000000000000888888882222222222222222222222222222222222222222288888888888888888800000000000000000000000000000
00000000000000000000000000000000888888882222222222222222222222222222222222222222228888888888888888800000000000000000000000000000
00000000000000000000000000000000088888888222222222222222222222222222222222222222228888888888888888800000000000000000000000000000
00000000000000000000000000000000088888888222222222222222222222222222222222222222228888888888888888800000000000000000000000000000
00000000000000000000000000000000008888888222222222222222222222222222222222222222228888888888888888880000000000000000000000000000
00000000000000000000000000000000008888888822222222222222222222222222222222222222222888888888888888880000000000000000000000000000
00000000000000000000000000000000008888888822222222222222222222222222222222222222222888888888888888880000000000000000000000000000
00000000000000000000000000000000008888888882222222222222222222222222222222222222222888888888888888888000000000000000000000000000
00000000000000000000000000000000000888888882222888822222222222222222222288882222222288888888888888888000000000000000000000000000
00000000000000000000000000000000000888888888888888822222222222222222888888882222222288888888888888888000000000000000000000000000
00000000000000000000000000000000000888888888888888822222222222222888888888882222222228888888888888888800000000000000000000000000
00000000000000000000000000000000000888888888888888882222222222288888888888888222222228888888888888888800000000000000000000000000
00000000000000000000000000000000000088888888888888882222222228888888888888888222222222888888888888888800000000000000000000000000
00000000000000000000000000000000000088888888888888882222222228888888888888888222228888888888888888888880000000000000000000000000
00000000000000000000000000000000000088888888888888888222222228888888888888888888888888888888888888888880000000000000000000000000
00000000000000000000000000000000000008888888888888888222222228888888888888888888888888888888888888888888000000000000000000000000
00000000000000000000000000000000000008888888888888888222222222888888888888888888888888888888888888880000000000000000000000000000
00000000000000000000000000000000000000888888888888888822222222888888888888888888888888888888888800000000000000000000000000000000
00000000000000000000000000000000000000888888888888888822222222888888888888888888888888888888000000000000000000000000000000000000
00000000000000000000000000000000000000088888888888888822222222288888888888888888888888888000000000000000000000000000000000000000
00000000000000000000000000000000000000088888888888888882222288888888888888888888888888000000000000000000000000000000000000000000
00000000000000000000000000000000000000088888888888888882228888888888888888888888888800000000000000000000000000000000000000000000
00000000000000000000000000000000000000088888888888888888888888888888888888888888880000000000000000000000000000000000000000000000
00000000000000000000000000000000000000008888888888888888888888888888888888888800000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000008888888888888888888888888888888888000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000008888888888888888888888888888888000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000888888888888888888888888888800000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000888888888888888888888888880000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000888888888888888888888800000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000888888888888888888000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000088888888888880000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000088888888880000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000088888880000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000088880000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

